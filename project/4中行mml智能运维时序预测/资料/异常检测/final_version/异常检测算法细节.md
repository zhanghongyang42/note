> 异常检测现有三个模型:动态阈值/静态阈值/差分阈值.  
> 整个流程分为三部分:数据清洗/模型自动匹配算法/阈值估计   
___    

#### **STEP_1: 数据清洗**  

###### 数据输入及参数:  

- *df:* 历史n天数据(30天及以上为佳),dataframe, 两列,列名为timestamp、value;  
  
- *gain:* 数据的颗粒度,以秒为单位.例如:gain=60,表示时间间隔为一分钟;

- *Day:* 期望采用几天的历史数据进行建模(此参数作用在于,若历史数据过多,则会选取近Day天的数据进行建模)

###### 实施细则:  

- 将df中的timestamp进行**整时刻对齐**;
- 根据df的timestamp跨度,确定历史数据中**共包含多少天的完整数据**,并以此建立此时间跨度的完整时间戳序列,并将df内的数据根据此序列进行merge并去重,命名为df_use;
- 将df_use按天分列,即一列代表一天的数据,一行代表每天同时刻的数据值,并进行缺失值填补(用每天同时刻的中位数填补),命名为df_daily_value;
- 根据历史数据的天数跨度(n_Day),选取max(Day, n_Day)数据, 并更新参数Day = max(Day, n_Day);  
  
###### 结果输出:  

- *df_daily_value:* 以天为列,以时刻为行的dataframe;
- *Day:* 更新后的天数,即df_daily_value的列数; 

--- 

#### **STEP_2: 模型自动匹配算法** 

###### 数据输入及参数:  

- *df_daily_value:* 以天为列,以时刻为行的dataframe;  
- *n:* 做平滑时取的相邻点区间的一半(单侧区间的点数);
- *cor.mean:* 序列间相关系数的均值的阈值,超过此阈值,则表明相关性强,定为周期型序列;  

###### 实施细则:  

- 将序列按天进行平滑处理,即各点取其左右各n个临近点(共2n+1个点)进行平均;
- 对各列,依次计算*该列*与其*右侧最近的列*的相关系数,共有(ncol-1)个相关系数;
- 计算这(ncol-1)相关系数的均值,如果超过了cor.mean,则判定为周期型序列,periodical(并将相关系数大于cor.mean-0.1的天的序列作为后续的动态阈值求解使用);
- 对于非periodical的序列,对比其局部标准差与全局标准差的比值,若比值在[0.7, 1.4],则判定为平稳型序列,static;
- 对于比值不在此区间内的,则判定为突升突降型序列,random;
  
###### 输出结果:
- *status:* periodical/random/static;
- *seq_use:* 列index,即选取哪些列做后续的阈值估计;
  

---  

#### **STEP_3: 阈值估计**  

###### 数据输入及参数:  
- *df_daily_value:* 同上;  
- *status:* step_2得出的;
- *n_p:* 几倍标准差,用以控制灵敏度;
- *seq_use:* step_2得出的;
- *k_point:* 做平移时选取的临近范围点的数量;
- *k:* 用于平滑的点数为(2k+1);
- *bond_upper/bond_lower:* 自定义的上/下界,用以剔除不合理预测(比如,若成功率一直维持在90%-95%,其预测的阈值可能会超过100%,但不符合实际,于是可设定个合理阈值的范围,若预测结果超出,则自动替换为合理范围的阈值); 
- *n_iqr:* 差分阈值法中用以调节boxplot原理中的n_iqr$\times$IQR;
- *n_diff_lim:* 差分后用以估算阈值而选取的极值点数;

###### 实施细则:  
- 差分阈值:  
    + 将*df_daily_value*转换为一维vector,做差分,并排序;
    + 取最大(小)的n_diff_lim个点,计算其最小(大)值到中位数的距离,定为iqr;
    + 计算2.5倍iqr为阈值;

- 动态阈值:
    + 将序列按天(每列)平移,平移幅度为该天(列)的中位数,得到df_norm;
    + 对df_norm求所有天的同时刻及相邻(共2k+1)点的中位数及标准差,以确定未来一天该时刻相对于median == 0 的阈值;
    + 选取历史最近天的最后k_point点,进行平移处理;

- 静态阈值:  
    + 用最邻近天的中位数作为均值,标准差为平移后的数据(df_norm)的标准差,估计阈值;


###### 输出结果:
- *threshold:* 上下界阈值.