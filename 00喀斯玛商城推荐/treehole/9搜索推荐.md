# 思路

### 召回和搜索结果碰

协同过滤，根据用户行为预测用户可能购买哪些商品，这个结果和搜索结果有多大的重合？



### 用户商品标签匹配

一是 商品的类目体系准确，根据用户购买/点击 行为，算出用户常购类目。进行匹配排序。

二是 用NLP的方法用商品属性给商品打上标签，根据用户购买/点击 行为，算出用户标签。进行匹配排序。

三是 用户的研究方向（标签）准确，根据用户购买/点击 行为，算出商品所属方向。进行匹配排序。

四是 用NLP的方法给用户打上标签，根据用户购买/点击 行为，算出商品标签，用传播算法传到其他商品上。进行匹配排序。



决定先实现思路四。因为用户的标签是研究方向，少且方便维护，容易准确。

用NLP的方法给用户打上标签，根据用户购买/点击 行为，算出商品标签，用传播算法传到其他商品上。进行匹配排序。



也需要看数据情况。



### query关键词预测类目

例子：电脑 -- 电子品类。

问题：需要建立商品类目体系。

现在酒精和酒精灯属于同一类目就很尴尬。



### 图算法找出用户商品群

可以尝试。

不具有购买行为的用户/新用户 不能推荐。



# 用户商品标签匹配

用户的研究方向标签可能有很多用户打不上。

没有购买行为的商品怎么通过购买行为和标签匹配。



### 给用户打标签（一次）

用户打标签：用关键词提取方法或者文本分类的方法 通过课题组名称找出 研究方向标签，得到表如下。

id  task_name reseh_dirction 



找出活跃用户，近一年发生过购买行为的。得到表如下：

id  task_name  reseh_dirction  activate



处理用户数非常少的研究方向。包含活跃用户的归类到其他研究方向中，不包含的，用其他代替。

第一次需要人工修正活跃用户的研究方向。按研究方向分组观察修正。



把这个表维护到业务数据库中。商城每日新增用户420人。

后续用户注册，要增加一个流程，需要用户自己选择研究方向。还要提供增加修改研究方向功能：

id  reseh_dirction



### 计算商品标签（脚本）

读取 研究方向表。读取订单表。

算出活跃用户：

id  task_name  reseh_dirction  activate



读取订单详情表，join出研究方向和商品关联表。

id  task_name  reseh_dirction  activate item time weight



研究方向按照出现次数 和权重 排序。

item reseh_dirctions weights



读取全量的商品表，选好特征，knn 计算出 相似类目 的商品。*尝试多种模型，分类算法，聚类算法，图算法，传播算法*

把相似商品的研究方向 复制过来

item reseh_dirctions weights



读取以前的商品标签表，把权重进行衰减 ，和现在的商品标签权重累加。得到最新的商品标签表。

item reseh_dirctions weights



倒排索引，存到es中？

reseh_dirction items weight



### 搜索时进行排序（线上）

web模块



用户搜索-- query --搜索结果items ：输入query，输出items

用户搜索 -- 用户id -- 用户研究方向 -- 研究方向 items ：输入用户id ，输出items



上面两个查询结果需要解耦 出来， 在一个统一的地方进行结果融合



### 资源

之前是一个离线的推荐系统。

现在每个步骤都要在线上交互。



离线机器：hive 数仓，spark/pyhton

在线：es，web，这块用我们系统的。

所以还是需要三台离线机器，一台开发机。

在线机器不用了，我们的输出可以输出的测试环境测试。



# query预测类目

query关键词预测类目 有多种方法，我们首先实现基于统计的 query预测类目 方法。



### 步骤

神策数据 事件类型SearchResultClick 中关键词和点击商品关系

```
关键词 商品ID
```

数据库中商品表

```
商品ID 商品二级分类
```



某个 query 对应的 点击 的所有商品的类目。通过阈值或者规则 找到主要类目。保存成一张表



搜索时先去查出主要类目，然后在es脚本中设置商品类目信息。



### 缺点优化

长尾query，对应的商品类目可能准确度一般。

如果有新的 query关键词，无法及时反应出来。



query对应类目可以根据时间衰减设置权重。

最后取得购买的的点击权重更高。

长尾query可以合并到同session的头部query中。

长尾query可以通过关键词匹配等方法合并打头部query中。

通过文本分类的方法预测 query 对应商品类目。

优化方法涉及到很多nlp的知识，我可以后续尝试着优化。有nlp或者搞搜索算法的人最好。



### 第一版方案

| 步骤                                                         | 人员       | 时间    |
| ------------------------------------------------------------ | ---------- | ------- |
| hive搭建、spark搭建、sqoop安装......                         | 运维工程师 | 4-5人天 |
| JDBC 把 神策埋点数据放进hive/数据中台并加工，尝试sqoop       | ETL工程师  | 2-3人天 |
| sqoop 把商品表放进hive/数据中台                              | ETL工程师  | 2-3人天 |
| spark计算并把结果存进在线（测试）数据库<br />对query做分词   | 算法工程师 | 30人天  |
| web模块，搜索时先查query的类目，再通过es脚本排序返回。（可在测试环境与上一步并行） | 后端工程师 | -- --   |
| 在线评价，优化                                               | 算法工程师 | ∞       |



# 用户商品类目匹配

### 前提条件

同一用户每次搜索的感兴趣的商品品类是大致不变的几种。

可以基于此通过购买行为把商品类目与用户关联，但是没有购买行为的用户就很难匹配上。



商品的二级类目是大致准确的。

用户的研究方向可以大致提取出来。



### 步骤

购买行为中，用户id对应商品id，商品id对应商品类目。

找到用户id对应商品类目。形成uid类目表



关键词提取找到每个用户的研究方向（可能有很多用户的研究方向找不到）。

算出研究方向对应商品类目，形成研究方向类目表。



搜索时，先查uid类目表，没有搜索研究方向类目。

搜索条件根据商品类目排序。























































































