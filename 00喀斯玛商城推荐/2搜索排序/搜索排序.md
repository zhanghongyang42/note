# 搜索服务现状

|                |            | 搜索结果到商品点击的转化率 | 商品详情到商品购买的转化率 | 搜索结果到购买的转化率 | 转化时间的中位数 |
| -------------- | ---------- | -------------------------- | -------------------------- | ---------------------- | ---------------- |
| 所有用户       | 按人数统计 | 55.2%                      | 23.39%                     | 13.2%                  | 6分39秒          |
|                | 按次数统计 | 26.17%                     | 11.84%                     | 3.1%                   |                  |
| 登录状态下用户 | 按人数统计 | 74.1%                      | 40.69%                     | 30.14%                 | 5分52秒          |
|                | 按次数统计 | 26.17%                     | 11.58%                     | 3.4%                   |                  |

按次数统计的转化率低于按人数统计的转化率，这说明搜索的用户有强烈的购买意愿，大部分最后都发生了购买行为，但是搜索次数非常多，搜索的体验较差。



线下AUC达到了0.72。auc代表被点击商品排在不被点击商品之前的概率。

线上评价指标 搜索结果到商品点击的转化率目前为26.17%，预计提升到30%以上。



转化率，关键词-点击位置（1-20），搜索排序服务 的覆盖率，      耗时，

需求：BI ，模型衰减，psi（特征分布）



# 排序搜索服务

### 搜索逻辑架构

![image-20220506181215759](picture/image-20220506181215759.png)



### 容灾备错

根据配送区灰度上线。如果配送区出现问题，不会大范围影响业务。

搜索排序打印出耗时与排序分和查询到商品数据的日志，方便查找问题。

搜索服务保留原来逻辑，随时可以切换掉现有排序算法。



### 搜索耗时

搜索耗时主要包括以下几部分：

搜索服务查询es耗时，搜索服务补数据耗时。这部分耗时是搜索排序前的耗时，已经非常快。

排序服务查数据耗时，这部分商品表耗时严重，把商品表数据减少到历史有过行为的商品（数据量从1亿减少到3百万）。

排序服务模型耗时，减少了string类型的特征字段，减少了pmml的大小（从85m减少到11m），节约了耗时。



### 搜索排序评价指标

线下AUC达到了0.72。auc代表被点击商品排在不被点击商品之前的概率。

线上评价指标 搜索结果到商品点击的转化率目前为26.17%，预计提升到30%以上。



### 马太效应问题

搜索排序的权重中包括用户前一段时间的行为分，这样就会导致越被购买的商品排序越靠前，排序越靠前的商品越容易被购买，使得长尾商品不被用户所看到。



首先这种现象具有一定的合理性，被购买的次数多的商品优先给用户排在前面，是符合用户的利益的。

其次我们目前的排序算法，除了用户行为，也用了如商品分类，用户课题组等不具有交互的静态数据，本省规避了一部分马太效应。

再者可以通过推荐来推出一些长尾商品。



### 搜索排序存在问题

目标不一致问题：我们排序算法的目标列是浏览但没有购买的为0，但实际要预测的是，浏览但没有发生点击的为0，两者存在差距。

特征非同分布：因为目标不同，训练特征中，很多label为1的数据导致特征的特征分布，与预测时大部分es召回数据的特征不是同分布的。

线上线下评价指标存在差距：线下auc上涨，未必导致线上点击率上涨。



### 优化方向

搜索曝光事件



加一些新特征，如转化率，购买时间编码，种类研究方向关联，配送区匹配，搜索词和优化keyword。这些特征构造困难，但是可能更有效果。

加工规范现有字段，如代理区域 值是 黑吉辽 ，模型难以准确分辨，需要进一步加工。

加购收藏使用日志行为,现在用的每天的最后状态，行为应该更有效。

上线其他的排序模型，做AB测试。



# 资源优化

调整yarn资源参数配置，使一个大表sql的 的执行时间由 25分钟减少到 18分钟































